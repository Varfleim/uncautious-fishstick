using System;
using System.Collections.Generic;

using Leopotam.EcsLite;
using Leopotam.EcsLite.Di;

using SO.Character;
using SO.Map.Events;

namespace SO.Map
{
    public class SRCControl : IEcsRunSystem
    {
        //Миры
        readonly EcsWorldInject world = default;


        //Карта
        readonly EcsFilterInject<Inc<CRegionCore>> regionFilter = default;
        readonly EcsPoolInject<CRegionCore> rCPool = default;

        readonly EcsPoolInject<CExplorationRegionFractionObject> exRFOPool = default;

        //Персонажи
        readonly EcsPoolInject<CCharacter> characterPool = default;

        readonly EcsPoolInject<CExplorationObserver> explorationObserverPool = default;


        //Данные
        readonly EcsCustomInject<RuntimeData> runtimeData = default;

        public void Run(IEcsSystems systems)
        {
            //Создание ExRFO
            ExRFOCreating();

            //Смена владельцев RC
            RCChangeOwners();
        }

        readonly EcsFilterInject<Inc<CCharacter, SRExRFOsCreating>> exRFOsCreatingSelfRequestFilter = default;
        readonly EcsPoolInject<SRExRFOsCreating> exRFOsCreatingSelfRequestPool = default;
        void ExRFOCreating()
        {
            //Если фильтр самозапросов не пуст
            if (exRFOsCreatingSelfRequestFilter.Value.GetEntitiesCount() > 0)
            {
                //Создаём временный список DRFO
                List<DRegionCharacterObject> tempRFO = new();

                //Определяем общее количество персонажей
                int charactersCount = runtimeData.Value.charactersCount;

                //Для каждого региона
                foreach (int regionEntity in regionFilter.Value)
                {
                    //Берём RC
                    ref CRegionCore rC = ref rCPool.Value.Get(regionEntity);

                    //Очищаем временный список
                    tempRFO.Clear();

                    //Для каждого персонажа с самозапросом создания ExRFO
                    foreach (int characterEntity in exRFOsCreatingSelfRequestFilter.Value)
                    {
                        //Берём персонажа и самозапрос
                        ref CCharacter character = ref characterPool.Value.Get(characterEntity);
                        ref SRExRFOsCreating selfRequestComp = ref exRFOsCreatingSelfRequestPool.Value.Get(characterEntity);

                        //Создаём новую сущность и назначаем ей компонент ExRFO
                        int rFOEntity = world.Value.NewEntity();
                        ref CExplorationRegionFractionObject exRFO = ref exRFOPool.Value.Add(rFOEntity);

                        //Заполняем основные данные ExRFO
                        exRFO = new(
                            world.Value.PackEntity(rFOEntity),
                            character.selfPE,
                            rC.selfPE);

                        //Создаём DRFO для хранения данных персонажа непосредственно в RC
                        DRegionCharacterObject rFO = new(
                            exRFO.selfPE);

                        //Заносим его во временный список
                        tempRFO.Add(rFO);
                    }

                    //Сохраняем старый размер массива
                    int oldArraySize = rC.rFOPEs.Length;

                    //Расширяем массив
                    Array.Resize(
                        ref rC.rFOPEs,
                        charactersCount);

                    //Для каждого DRFO во временном массиве
                    for (int a = 0; a < tempRFO.Count; a++)
                    {
                        //Вставляем DRFO в массив по индексу
                        rC.rFOPEs[oldArraySize++] = tempRFO[a];
                    }
                }

                //Для каждого самозапроса создания ExRFO
                foreach (int characterEntity in exRFOsCreatingSelfRequestFilter.Value)
                {
                    exRFOsCreatingSelfRequestPool.Value.Del(characterEntity);
                }
            }
        }

        readonly EcsFilterInject<Inc<RRCChangeOwner>> rCChangeOwnerRequestFilter = default;
        readonly EcsPoolInject<RRCChangeOwner> rCChangeOwnerRequestPool = default;
        void RCChangeOwners()
        {
            //Для каждого запроса смены владельца RC
            foreach (int requestEntity in rCChangeOwnerRequestFilter.Value)
            {
                //Берём запрос
                ref RRCChangeOwner requestComp = ref rCChangeOwnerRequestPool.Value.Get(requestEntity);

                //Берём персонажа, которая становится владельцем RC
                requestComp.characterPE.Unpack(world.Value, out int characterEntity);
                ref CCharacter character = ref characterPool.Value.Get(characterEntity);

                //Берём RC
                requestComp.regionPE.Unpack(world.Value, out int regionEntity);
                ref CRegionCore rC = ref rCPool.Value.Get(regionEntity);

                //Если смена владельца происходит при инициализации
                if (requestComp.requestType == RCChangeOwnerType.Initialization)
                {
                    RCChangeOwnerInitialization();
                }


                //Создаём событие, сообщающее о смене владельца RC
                RegionCoreChangeOwnerEvent(
                    rC.selfPE,
                    character.selfPE, rC.ownerCharacterPE);


                //Указываем персонажа-владельца RC
                rC.ownerCharacterPE = character.selfPE;

                //ТЕСТ
                //Заносим PE региона в список персонажа
                character.ownedRCPEs.Add(rC.selfPE);

                //Берём ExRFO персонажа игрока
                rC.rFOPEs[character.selfIndex].rFOPE.Unpack(world.Value, out int rFOEntity);
                ref CExplorationRegionFractionObject exRFO = ref exRFOPool.Value.Get(rFOEntity);

                //Назначаем RFO компонент наблюдателя и сохраняем ссылку на него в список персонажа
                ref CExplorationObserver exObserver = ref explorationObserverPool.Value.Add(rFOEntity);
                character.observerPEs.Add(exRFO.selfPE);
                //ТЕСТ

                rCChangeOwnerRequestPool.Value.Del(requestEntity);
            }
        }

        void RCChangeOwnerInitialization()
        {

        }

        readonly EcsPoolInject<ERegionCoreChangeOwner> rCChangeOwnerEventPool = default;
        void RegionCoreChangeOwnerEvent(
            EcsPackedEntity regionPE,
            EcsPackedEntity newOwnerCharacterPE, EcsPackedEntity oldOwnerCharacterPE = new())
        {
            //Создаём новую сущность и назначаем ей событие смены владельца RC
            int eventEntity = world.Value.NewEntity();
            ref ERegionCoreChangeOwner eventComp = ref rCChangeOwnerEventPool.Value.Add(eventEntity);

            //Заполняем данные события
            eventComp = new(
                regionPE,
                newOwnerCharacterPE, oldOwnerCharacterPE);
        }
    }
}